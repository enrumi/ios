name: Build Rift iOS IPA

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: List directory structure
      run: |
        echo "ğŸ“ Project structure:"
        ls -la
        echo ""
        echo "ğŸ“± Xcode project:"
        ls -la Rift.xcodeproj/
    
    - name: Build Archive
      run: |
        xcodebuild -project Rift.xcodeproj \
          -scheme Rift \
          -sdk iphoneos \
          -configuration Release \
          -archivePath $PWD/build/Rift.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Create unsigned IPA
      run: |
        mkdir -p build/Payload
        cp -r build/Rift.xcarchive/Products/Applications/Rift.app build/Payload/
        cd build
        zip -r Rift-unsigned.ipa Payload
        rm -rf Payload
        ls -lh Rift-unsigned.ipa
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: Rift-IPA
        path: build/*.ipa
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: build/*.ipa
        body: |
          ## ğŸ¬ Rift - TikTok Clone for iOS
          
          **A full-featured TikTok clone built with SwiftUI**
          
          ### ğŸ“± Installation
          1. Download the `Rift-unsigned.ipa` file
          2. Sideload using one of these tools:
             - **AltStore** (recommended for free accounts)
             - **Sideloadly** (Windows/Mac)
             - **TrollStore** (if available for your iOS version)
          3. Trust the certificate in Settings â†’ General â†’ VPN & Device Management
          
          ### âœ¨ Features
          
          **Feed (Home):**
          - â¬†ï¸ Vertical video paging (swipe up/down)
          - ğŸ’— Double tap to like with heart animation
          - ğŸ‘† Single tap to pause/play
          - ğŸ’¬ Comments sheet
          - ğŸ“³ Haptic feedback
          - ğŸ”„ Auto-play/pause
          - â™¾ï¸ Infinite scroll with pagination
          
          **Discover:**
          - ğŸ” Search videos and users
          - ğŸ“Š Trending hashtags
          - ğŸï¸ 3-column video grid
          - ğŸ† Popular content
          
          **Upload:**
          - ğŸ“¤ Upload videos from camera roll
          - âœï¸ Add captions
          - ğŸ“¹ Video preview with AVPlayer
          - â˜ï¸ Direct upload to MinIO storage
          
          **Profile:**
          - ğŸ‘¤ User profile with stats
          - ğŸ“Š Following, Followers, Likes count
          - ğŸ¬ Video grid (3 columns)
          - â• Follow/Unfollow button
          - âš™ï¸ Edit profile
          - ğŸšª Logout
          
          **Comments:**
          - ğŸ’¬ View all comments
          - âœï¸ Post new comments
          - ğŸ“± Sheet with drag-to-dismiss
          - âš¡ Real-time updates
          
          **Authentication:**
          - ğŸ” Login/Register
          - ğŸ”‘ JWT token authentication
          - ğŸ”’ Secure keychain storage
          - ğŸ”„ Auto token refresh
          
          ### ğŸ”§ Backend Setup Required
          
          This app requires a backend server. You need to:
          
          1. **Clone the repository**
          2. **Start the backend:**
             ```bash
             cd rift
             docker compose up -d
             cd backend
             npm install
             npm run db:migrate
             npm run db:seed
             npm run dev
             ```
          3. **Update server IP in the app:**
             - Open `rift/ios/Rift/Core/Utils/Constants.swift`
             - Change `baseURL` to your server's IP address
             - Rebuild the app
          
          ### ğŸ“ Default Test Accounts
          
          After running `npm run db:seed`:
          - Username: `alex_dev` | Password: `password123`
          - Username: `sarah_creative` | Password: `password123`
          
          ### ğŸ—ï¸ Tech Stack
          
          **iOS (Frontend):**
          - SwiftUI (iOS 17+)
          - AVFoundation (video playback)
          - MVVM architecture
          - Combine framework
          - PhotosPicker
          - Keychain for secure storage
          
          **Backend:**
          - Node.js + TypeScript
          - Fastify (web framework)
          - PostgreSQL (database)
          - Prisma (ORM)
          - MinIO (S3-compatible storage)
          - JWT authentication
          - Docker Compose
          
          ### ğŸ“š API Endpoints
          
          - Auth: Login, Register, Logout, Refresh token
          - Users: Profile, Edit, Follow/Unfollow
          - Videos: Create, Get, Delete, Feed
          - Interactions: Like, Comment, Share
          - Search: Videos, Users, Hashtags
          - Upload: Presigned URLs for direct upload
          
          ### âš ï¸ Important Notes
          
          - **Unsigned IPA:** You need to sign it yourself or use a sideloading tool
          - **Backend Required:** The app won't work without a running backend server
          - **Network Access:** Ensure your iPhone can reach the backend server IP
          - **iOS 17+:** Minimum iOS version required
          
          ### ğŸ› Known Issues
          
          - Video preloading not implemented (may cause stuttering on slow connections)
          - Some placeholder features (Inbox/Notifications)
          
          ### ğŸ“– Documentation
          
          - Full API docs: `rift/backend/API.md`
          - iOS setup: `rift/ios/README.md`
          - Backend setup: `rift/backend/README.md`
          
          ### ğŸ¤ Contributing
          
          This is a demonstration project showing how to build a production-quality TikTok clone.
          Feel free to use it for learning purposes!
          
          ---
          
          **Built with â¤ï¸ using SwiftUI and Node.js**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
